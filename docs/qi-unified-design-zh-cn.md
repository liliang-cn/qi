# Qi 编程语言统一设计文档

---

### Qi 编程语言统一设计文档

**Qi 语言**：100% 中文关键字的现代编程语言，文件后缀 .qi
**设计理念**：中文语法 + Rust 编译器前端 + Rust 运行时 (M:N 调度) + C 平台抽象接口 + LLVM 后端
**目标**：提供完全中文的开发体验，同时保持高性能、高并发和底层控制能力，支持编译到 Windows, Linux, macOS 和 WebAssembly。

---

## 目录

1. [设计概述](#1-设计概述)
2. [语言关键字总表](#2-语言关键字总表)
3. [完整语法规范](#3-完整语法规范)
4. [编译器架构设计](#4-编译器架构设计)
5. [运行时 C 接口](#5-运行时-c-接口平台抽象层)
6. [项目结构](#6-项目结构)
7. [标准库与包系统](#7-标准库与包系统)
8. [并发模型](#8-并发模型-mn-协程调度)
9. [示例代码](#9-示例代码)
10. [实现计划](#10-实现计划)
11. [工具链支持](#11-工具链支持-lsp-与语法高亮)

---

## 1. 设计概述

### 1.1 核心设计原则

- **100% 中文关键字**：所有语言关键字均使用中文，无任何英文保留字。
- **统一架构**：Rust 编译器 + Rust 运行时 + C 系统调用 + LLVM 后端。
- **性能优先**：编译到原生机器码，零运行时开销。
- **现代特性**：支持 M:N 协程并发 (类似 Goroutine)、错误处理、泛型等。
- **跨平台**：通过 LLVM 和平台抽象层，原生支持 Windows, Linux, macOS 和 WASM (WASI)。
- **开发友好**：提供完整的工具链 (LSP、语法高亮) 和标准库。

### 1.2 技术栈

| 组件         | 技术栈                | 作用                                                  |
| :----------- | :-------------------- | :---------------------------------------------------- |
| **词法分析** | Rust + LALRPOP        | Token 解析，支持 UTF-8 中文                           |
| **语法分析** | Rust + LALRPOP        | AST 构建，错误恢复                                    |
| **中间代码** | Rust + inkwell        | LLVM IR 生成                                          |
| **代码优化** | LLVM                  | 标准优化管道                                          |
| **运行时**   | **Rust + C**          | 内存管理、并发调度 (Rust, M:N), 系统调用 (C 抽象接口) |
| **标准库**   | Qi 语言 + C/Rust 绑定 | 基础设施和常用功能                                    |

### 1.3 文件命名

- **源文件**：.qi 后缀
- **包文件**：包名.qi 或 模块名.qi
- **配置文件**：qimod.json
- **构建产物**：.o、.ll、可执行文件

---

## 2. 语言关键字总表

### 2.1 程序结构与模块

| 关键字 | 含义            | 类似于        | 示例                           |
| :----- | :-------------- | :------------ | :----------------------------- |
| `包`   | 声明包名/模块名 | mod/namespace | `包 主程序`                    |
| `导入` | 导入模块或库    | use/#include  | `导入 标准库.输入输出`         |
| `公开` | 对外可见        | pub/extern    | `公开 函数 ...`                |
| `私有` | 模块内可见      | private       | `私有 变量 ...`                |
| `作为` | 引入别名        | as            | `导入 标准库.数学 作为 数学库` |
| `常量` | 定义常量        | const         | `常量 PI = 3.14159`            |
| `静态` | 静态变量        | static        | `静态 计数器 = 0`              |

### 2.2 类型与变量

| 关键字     | 含义             | 类似于          | 示例                   |
| :--------- | :--------------- | :-------------- | :--------------------- |
| `变量`     | 声明变量（可变） | let mut/auto    | `变量 计数器 = 0`      |
| `不可变`   | 声明不可变变量   | let             | `不可变 名称 = "张三"` |
| `类型`     | 定义自定义类型   | type/typedef    | `类型 用户ID = 整数`   |
| `结构体`   | 定义结构体       | struct          | `结构体 用户 {...}`    |
| `枚举`     | 定义枚举         | enum            | `枚举 结果 {...}`      |
| `联合体`   | 定义联合体       | union           | `联合体 数值 {...}`    |
| `实现`     | 实现方法或特性   | impl            | `实现 用户 {...}`      |
| `特性`     | trait/接口       | trait/interface | `特性 显示 {...}`      |
| `自我`     | 当前类型         | Self            | `返回 自我`            |
| `自身`     | 当前对象         | self/this       | `函数 显示(自身)`      |
| `指针`     | 指针类型         | *               | `指针<整数>`           |
| `引用`     | 引用类型         | &               | `引用<字符串>`         |
| `可变引用` | 可变引用         | &mut            | `可变引用<数组>`       |

### 2.3 控制流程

| 关键字 | 含义         | 类似于        | 示例                        |
| :----- | :----------- | :------------ | :-------------------------- |
| `如果` | 条件判断     | if            | `如果 条件 {...}`           |
| `否则` | 否则分支     | else          | `否则 {...}`                |
| `匹配` | 模式匹配     | match         | `匹配 值 {...}`             |
| `循环` | 无限循环     | loop/while(1) | `循环 {...}`                |
| `当`   | 条件循环     | while         | `当 条件 {...}`             |
| `对于` | for 循环     | for           | `对于 元素 在 列表中 {...}` |
| `中断` | 跳出循环     | break         | `中断`                      |
| `继续` | 跳过当前循环 | continue      | `继续`                      |
| `返回` | 返回函数结果 | return        | `返回 值`                   |
| `跳转` | goto 跳转    | goto          | `跳转 标签`                 |

### 2.4 函数与闭包

| 关键字     | 含义         | 类似于         | 示例                          |
| :--------- | :----------- | :------------- | :---------------------------- |
| `函数`     | 定义函数     | fn/function    | `函数 整数 计算(...)`         |
| `内联`     | 内联函数     | inline         | `内联 函数 快速计算()`        |
| `异步`     | 异步函数     | async          | `异步 函数 网络请求()`        |
| `等待`     | 等待异步完成 | await          | `等待 网络请求()`             |
| `闭包`     | 匿名函数     | lambda/closure | `闭包 (参数) {...}`           |
| `返回类型` | 指定返回类型 | ->             | `函数 返回类型 字符串 名称()` |

### 2.5 错误与异常

| 关键字 | 含义          | 类似于 | 示例                       |
| :----- | :------------ | :----- | :------------------------- |
| `抛出` | 抛出异常/错误 | throw  | `抛出 错误信息`            |
| `捕获` | 捕获异常      | catch  | `捕获 错误 {...}`          |
| `尝试` | 尝试执行      | try    | `尝试 危险操作()`          |
| `结果` | Result 类型   | Result | `结果<成功类型, 错误类型>` |
| `选项` | Option 类型   | Option | `选项<类型>`               |

### 2.6 内存与所有权

| 关键字 | 含义          | 类似于     | 示例          |
| :----- | :------------ | :--------- | :------------ |
| `拥有` | 拥有权标识    | 所有权机制 | `拥有 变量`   |
| `借用` | 借用          | Rust 借用  | `借用 引用`   |
| `移动` | 所有权移动    | move       | `移动 变量`   |
| `克隆` | 显式复制      | clone      | `克隆 对象`   |
| `释放` | 释放内存/资源 | drop       | `释放 资源`   |
| `新建` | 创建对象      | new        | `新建 实例()` |

### 2.7 并发与线程

| 关键字 | 含义               | 类似于     | 示例              |
| :----- | :----------------- | :--------- | :---------------- |
| `并行` | 并行块/计算        | parallel   | `并行 {...}`      |
| `并发` | 并发块             | concurrent | `并发 {...}`      |
| `任务` | 轻量线程           | task/tokio | `任务 异步工作()` |
| `启动` | 启动轻量任务(协程) | go / spawn | `启动 后台任务()` |
| `线程` | 系统线程           | thread     | `线程 工作线程()` |
| `锁`   | 互斥锁             | mutex      | `锁 保护变量`     |
| `原子` | 原子操作           | atomic     | `原子 计数器`     |

### 2.8 基础数据类型

| 关键字   | 含义           | 类似于     | 示例                        |
| :------- | :------------- | :--------- | :-------------------------- |
| `整数`   | 整型           | i32/int    | `整数 年龄 = 25`            |
| `长整数` | 64 位整型      | i64/long   | `长整数 大数 = 1000000`     |
| `短整数` | 16 位整型      | i16/short  | `短整数 小数 = 100`         |
| `字节`   | 8 位无符号整数 | u8/byte    | `字节 数据 = 255`           |
| `浮点数` | 浮点型         | f64/double | `浮点数 精度 = 3.14`        |
| `布尔`   | 布尔型         | bool       | `布尔 标志 = 真`            |
| `字符`   | 单个字符       | char       | `字符 字母 = 'A'`           |
| `字符串` | 字符串类型     | String     | `字符串 姓名 = "张三"`      |
| `空`     | 空类型         | void/()    | `函数 空 初始化()`          |
| `数组`   | 数组类型       | array      | `数组<整数> 数字列表`       |
| `字典`   | 键值映射       | map/dict   | `字典<字符串, 整数> 映射表` |
| `列表`   | 顺序列表       | Vec/List   | `列表<字符串> 名称列表`     |
| `集合`   | 无重复集合     | Set        | `集合<整数> 唯一数字`       |

### 2.9 操作符关键字

| 关键字     | ASCII 等价 | 含义       | 优先级 |
| :--------- | :--------- | :--------- | :----- |
| `加`       | +          | 加法       | 高     |
| `减`       | -          | 减法       | 高     |
| `乘`       | *          | 乘法       | 高     |
| `除`       | /          | 除法       | 高     |
| `取余`     | %          | 取余数     | 高     |
| `等于`     | ==         | 等于比较   | 中     |
| `不等于`   | !=         | 不等于比较 | 中     |
| `大于`     | >          | 大于比较   | 中     |
| `小于`     | <          | 小于比较   | 中     |
| `大于等于` | >=         | 大于等于   | 中     |
| `小于等于` | <=         | 小于等于   | 中     |
| `与`       | &&         | 逻辑与     | 低     |
| `或`       | \|\|       | 逻辑或     | 低     |
| `非`       | !          | 逻辑非     | 高     |

### 2.10 特殊关键字

| 关键字       | 含义     | 用途               |
| :----------- | :------- | :----------------- |
| `真`         | 布尔真值 | `真` / `假`        |
| `假`         | 布尔假值 | `真` / `假`        |
| `空指针`     | 空指针   | `空指针`           |
| `主程序入口` | 主函数   | `主程序入口()`     |
| `打印`       | 标准输出 | `打印("消息")`     |
| `输入`       | 标准输入 | `变量 值 = 输入()` |
| `长度`       | 获取长度 | `字符串.长度()`    |
| `包含`       | 检查包含 | `列表.包含(元素)`  |

---

## 3. 完整语法规范

### 3.1 基本语法规则

```qi
// 注释：单行注释（//）和块注释（/* */）
// 语句结束：分号（;）
// 代码块：大括号（{}）
// 字符集：UTF-8，支持所有中文字符

// 示例：基础函数
函数 整数 计算总和(整数 数字1, 整数 数字2) {
    变量 结果 = 数字1 + 数字2;
    返回 结果;
}
```

### 3.2 变量声明

```qi
// 可变变量
变量 计数器 = 0;
变量 姓名 = "张三";
变量 年龄 = 25;

// 不可变变量
不可变 常量值 = 3.14159;
不可变 固定名称 = "固定名称";

// 类型推断
变量 推断值 = 42; // 自动推断为整数
变量 文本 = "Hello"; // 自动推断为字符串

// 显式类型声明
变量 整数值: 整数 = 100;
变量 浮点值: 浮点数 = 3.14;
变量 文本值: 字符串 = "文本";
```

### 3.3 结构体定义

```qi
// 基础结构体
结构体 用户 {
    整数 ID;
    字符串 姓名;
    整数 年龄;
    布尔 活跃状态;
}

// 嵌套结构体
结构体 地址 {
    字符串 国家;
    字符串 城市;
    字符串 街道;
}

结构体 完整用户 {
    用户 基本信息;
    地址 联系地址;
    列表<字符串> 兴趣爱好;
}

// 泛型结构体
结构体 容器<类型 T> {
    数据: T;
    大小: 整数;
}
```

### 3.4 枚举定义

```qi
// 基础枚举
枚举 状态 {
    成功,
    失败,
    进行中
}

// 带数据的枚举
枚举 结果<成功类型, 错误类型> {
    成功(成功类型),
    失败(错误类型)
}

// 复杂枚举
枚举 网络响应 {
    成功(字符串 数据),
    失败(整数 错误码, 字符串 错误信息),
    重定向(字符串 新地址),
    超时
}
```

### 3.5 函数定义

```qi
// 基础函数
函数 整数 加法(整数 a, 整数 b) {
    返回 a + b;
}

// 返回多个值（使用元组或结构体）
函数 (整数, 字符串) 获取用户信息(整数 用户ID) {
    // ... 实现
    返回 (ID, "用户名");
}

// 异步函数
异步 函数 字符串 网络请求(字符串 URL) {
    // ... 网络请求实现
    等待 连接(URL);
    返回 "响应数据";
}

// 泛型函数
函数<T> 空 交换(可变引用<T> a, 可变引用<T> b) {
    变量 临时 = a;
    a = b;
    b = 临时;
}
```

### 3.6 控制流程

```qi
// 条件语句
函数 字符串 判断年龄分级(整数 年龄) {
    如果 年龄 < 18 {
        返回 "未成年";
    } 否则 如果 年龄 < 65 {
        返回 "成年人";
    } 否则 {
        返回 "老年人";
    }
}

// 循环语句
函数 整数 计算1到n的和(整数 n) {
    变量 总和 = 0;
    变量 i = 1;

    当 i <= n {
        总和 = 总和 + i;
        i = i + 1;
    }

    返回 总和;
}

// For 循环
函数 空 打印列表元素(列表<字符串> 名称列表) {
    对于 名称 在 名称列表 {
        打印("姓名: {}", 名称);
    }
}

// 模式匹配
函数 字符串 处理结果(结果<字符串, 整数> 结果值) {
    匹配 结果值 {
        结果::成功(数据) => {
            返回 "成功: " + 数据;
        }
        结果::失败(错误码) => {
            返回 "失败，错误码: " + 错误码.转字符串();
        }
    }
}
```

### 3.7 包系统

```qi
// 文件：数学工具.qi
包 数学工具;

// 导出函数
公开 函数 浮点数 计算圆面积(浮点数 半径) {
    常量 PI = 3.14159265359;
    返回 PI * 半径 * 半径;
}

公开 函数 整数 阶乘(整数 n) {
    如果 n <= 1 {
        返回 1;
    } 否则 {
        返回 n * 阶乘(n - 1);
    }
}

// 文件：主程序.qi
导入 数学工具;

函数 整数 主程序入口() {
    变量 面积 = 数学工具.计算圆面积(5.0);
    打印("圆的面积: {}", 面积);

    变量 结果 = 数学工具.阶乘(6);
    打印("6的阶乘: {}", 结果);

    返回 0;
}
```

### 3.8 并发与任务 (协程)

`启动` 关键字用于并发执行一个函数调用或一个异步块，而不会阻塞当前线程。这会创建一个新的 Qi `任务`（等同于 Goroutine），并将其提交给 Rust 运行时的 M:N 调度器。

```qi
// 示例 1：启动一个普通函数

函数 轻量任务() {
    变量 i = 0;
    当 i < 5 {
        打印("... 任务运行中 ... {}", i);
        i = i + 1;
        // 让出CPU，允许其他任务运行
        // (标准库需要提供 '任务::让出()' 或 '休眠')
        任务.休眠(100);
    }
    打印("轻量任务完成");
}

函数 主程序入口() {
    打印("启动一个新任务...");

    // 使用 '启动' 关键字，立即返回
    启动 轻量任务();

    打印("主函数继续执行...");
    // 主函数必须等待，否则程序会立即退出
    任务.休眠(1000);
    打印("主函数退出");
}
```

```qi
// 示例 2：启动一个 '异步' 块

异步 函数 字符串 获取数据(整数 任务ID) {
    打印("任务 {} 开始获取数据...", 任务ID);
    // 模拟非阻塞 I/O
    等待 任务.异步休眠(500);
    返回 "数据 " + 任务ID.转字符串();
}

函数 主程序入口() {
    // 启动一个异步块
    启动 异步 {
        打印("异步块 1 开始...");
        变量 数据1 = 等待 获取数据(1);
        打印("异步块 1 收到: {}", 数据1);
    };

    // 启动另一个异步块
    启动 异步 {
        打印("异步块 2 开始...");
        变量 数据2 = 等待 获取数据(2);
        打印("异步块 2 收到: {}", 数据2);
    };

    // 保持主线程存活以等待异步任务完成
    任务.休眠(2000);
}
```

---

## 4. 编译器架构设计

### 4.1 整体架构 (含多平台目标)

```
┌─────────────────────────────────────┐
│           Qi 源代码 (.qi)           │
├─────────────────────────────────────┤
│         Rust 编译器前端              │
│  ┌─────────────┬─────────────────┐   │
│  │  词法分析器  │    语法分析器    │   │
│  │  (Lexer)    │    (Parser)     │   │
│  └─────────────┴─────────────────┘   │
├─────────────────────────────────────┤
│         Rust 编译器中端              │
│  ┌─────────────┬─────────────────┐   │
│  │   语义分析   │    中间代码生成  │   │
│  │   (Sema)    │     (IR Gen)    │   │
│  └─────────────┴─────────────────┘   │
├─────────────────────────────────────┤
│         Rust 编译器后端 (LLVM)       │
│  ┌─────────────┬─────────────────┐   │
│  │  LLVM IR 生成 │   LLVM 优化器   │   │
│  │  (inkwell)  │   (Optimizer)   │   │
│  └─────────────┴─────────────────┘   │
├─────────────────────────────────────┤
│          Rust 运行时 (Qi-Runtime)   │
│  ┌─────────────┬─────────────────┐   │
│  │  内存管理    │    并发调度器    │   │
│  │ (GC/ARC)    │ (M:N, Async)    │   │
│  └─────────────┴─────────────────┘   │
├─────────────────────────────────────┤
│       C 系統調用接口 (平台抽象层)    │
│    (平台抽象层 - 见第 5 节)        │
├─────────────────────────────────────┤
│        目标平台 (通过 LLVM 支持)      │
│  ┌─────────┬─────────┬─────────┐   │
│  │  Windows │  Linux  │  macOS  │   │
│  │ (x86_64)│ (x86_64)│ (ARM64) │   │
│  ├─────────┴─────────┴─────────┤   │
│  │      WASM (WASI)            │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## 5. 运行时 C 接口（平台抽象层）

根据设计，Qi 的核心运行时（如内存管理、M:N 协程调度）将主要由 Rust 实现。

本节定义的 C 头文件（.h）代表了 **Rust 运行时** 与 **底层操作系统** 之间的**最小接口层 (FFI)**。**这是一个"平台抽象层"**。

---

## 6. 项目结构

当前项目结构遵循 Rust 标准工作区布局：

```
qi/
├── Cargo.toml              # Rust 工作区配置
├── README.md               # 项目说明
├── build.rs                # 构建脚本 (LALRPOP)
├── src/
│   ├── main.rs             # CLI 入口
│   ├── lib.rs              # 库入口
│   ├── cli/                # 命令行接口
│   ├── lexer/              # 词法分析器
│   ├── parser/             # 语法分析器
│   ├── semantic/           # 语义分析器
│   ├── codegen/            # 代码生成 (LLVM)
│   ├── runtime/            # Rust 运行时
│   │   ├── async_runtime/  # 异步运行时 (M:N)
│   │   ├── memory/         # 内存管理
│   │   ├── io/             # I/O 接口
│   │   └── stdlib/         # 标准库绑定
│   ├── targets/            # 目标平台支持
│   └── utils/              # 工具函数
├── tests/                  # 测试文件
├── examples/               # 示例程序
└── docs/                   # 文档
```

---

## 7. 标准库与包系统

- **包系统**：基于文件系统。一个目录是一个包。使用 `qimod.json` 管理依赖。
- **标准库**：将提供 `io` (输入输出)、`collections` (集合)、`threading` (并发与任务)、`net` (网络)、`math` (数学) 等核心模块。
- **实现**：大部分标准库将用 Qi 语言（`.qi`）编写，底层操作（如 I/O）通过 Rust 运行时的 FFI 接口调用系统 API。

---

## 8. 并发模型 (M:N 协程调度)

Qi 语言采用 M:N 协程调度模型，类似于 Go 语言的 Goroutine 和 Rust 的 `async` 运行时（如 Tokio）。

### 8.1 核心概念

1. **任务 (Task)**：Qi 的最小并发单元，等同于一个"协程"或"Goroutine"。
2. **原生线程 (OS Thread)**：由操作系统内核调度的标准线程。
3. **调度器 (Scheduler)**：位于 **Rust 运行时 (`src/runtime/async_runtime/`)** 的核心组件。

### 8.2 M:N 调度模型

- Qi 运行时将在启动时创建一个"原生线程池"，线程数量 (N) 通常等于 CPU 的逻辑核心数。
- 当 Qi 程序员使用 `启动` 关键字时，他们会创建 M 个 `任务`。
- Qi 调度器负责将这 M 个 `任务`在 N 个工作线程上进行复用和分发。

---

## 9. 示例代码

详见 `examples/qi/` 目录。

---

## 10. 实现计划

1. **阶段一：核心编译器** ✅ (进行中)
   - 词法分析器、语法分析器基础实现
   - AST 构建
   - LLVM IR 生成框架

2. **阶段二：运行时与平台接口** ✅ (进行中)
   - Rust 运行时基础框架
   - 异步运行时 (M:N 调度器)
   - 内存管理接口

3. **阶段三：高级特性** (待实现)
   - 完整的中文关键字支持
   - 泛型、结构体、枚举
   - 标准库实现

4. **阶段四：工具链** (待实现)
   - LSP 语言服务器
   - VS Code 插件
   - 文档生成器

---

## 11. 工具链支持 (LSP 与语法高亮)

为了提供现代化的开发体验，Qi 语言项目将包含：

1. **语言服务器 (qi-lsp)**：提供代码补全、诊断、悬停提示等
2. **语法高亮**：支持 VS Code、Sublime Text 等主流编辑器
3. **调试器支持**：基于 LLVM 的调试信息生成

---

## 附录：中文关键字映射表

| 中文关键字 | 英文等价    | 用途说明               |
| :--------- | :---------- | :--------------------- |
| 包         | mod         | 模块声明               |
| 导入       | use         | 导入模块               |
| 函数       | fn          | 函数定义               |
| 变量       | let mut     | 可变变量               |
| 不可变     | let         | 不可变变量             |
| 如果       | if          | 条件分支               |
| 否则       | else        | 否则分支               |
| 当         | while       | 条件循环               |
| 对于       | for         | 迭代循环               |
| 返回       | return      | 函数返回               |
| 结构体     | struct      | 结构体定义             |
| 枚举       | enum        | 枚举定义               |
| 特性       | trait       | 接口定义               |
| 实现       | impl        | 实现方法               |
| 异步       | async       | 异步函数               |
| 等待       | await       | 等待异步结果           |
| 启动       | spawn       | 启动协程               |
| 任务       | task        | 协程任务               |
| 整数       | i32         | 32位整数类型           |
| 长整数     | i64         | 64位整数类型           |
| 浮点数     | f64         | 64位浮点数类型         |
| 字符串     | String      | 字符串类型             |
| 布尔       | bool        | 布尔类型               |
| 真         | true        | 布尔真值               |
| 假         | false       | 布尔假值               |
| 打印       | println!    | 打印到标准输出         |
| 公开       | pub         | 公开可见性             |
| 私有       | (默认)      | 私有可见性             |
| 常量       | const       | 常量定义               |
| 静态       | static      | 静态变量               |
| 匹配       | match       | 模式匹配               |
| 循环       | loop        | 无限循环               |
| 中断       | break       | 跳出循环               |
| 继续       | continue    | 继续下一次循环         |
| 引用       | &           | 不可变引用             |
| 可变引用   | &mut        | 可变引用               |
| 克隆       | clone       | 克隆对象               |
| 移动       | move        | 移动语义               |
| 借用       | borrow      | 借用语义               |
| 空         | ()          | 单元类型               |
| 选项       | Option      | 可选值类型             |
| 结果       | Result      | 结果类型（成功或错误） |
| 尝试       | try         | 错误传播               |
| 抛出       | throw       | 抛出错误               |
| 捕获       | catch       | 捕获错误               |

---

**版本**：v1.0  
**最后更新**：2025-01-23  
**维护者**：Qi 语言团队
