# qifmt 代码格式化规范

## 概述

`qifmt` 是 Qi 语言的官方代码格式化工具，提供一致的代码风格。

## 设计原则

1. **零配置**: 默认配置适用于大多数项目
2. **确定性**: 相同的代码总是产生相同的格式化结果
3. **幂等性**: 格式化后的代码再次格式化不会改变
4. **保留语义**: 格式化不改变代码的语义

## 格式化规则

### 1. 缩进

- 使用 **4 个空格** 作为一级缩进
- 不使用制表符（Tab）

```qi
// ✅ 正确
函数 示例() {
    变量 x = 10;
    如果 x > 5 {
        打印(x);
    }
}

// ❌ 错误（2 空格）
函数 示例() {
  变量 x = 10;
  如果 x > 5 {
    打印(x);
  }
}
```

### 2. 行长度

- **最大行长度**: 100 字符
- 超过限制时自动换行

```qi
// ✅ 正确：自动换行
函数 长函数名(
    第一个参数: 整数,
    第二个参数: 字符串,
    第三个参数: 浮点数
): 整数 {
    返回 第一个参数;
}

// ❌ 错误：超过 100 字符
函数 长函数名(第一个参数: 整数, 第二个参数: 字符串, 第三个参数: 浮点数): 整数 {
    返回 第一个参数;
}
```

### 3. 空行

- 顶层声明之间：**2 个空行**
- 方法之间：**1 个空行**
- 逻辑块之间：**0-1 个空行**（可选）

```qi
包 主程序;


函数 第一个函数() {
    变量 x = 1;
}


函数 第二个函数() {
    变量 y = 2;
}


结构体 示例 {
    字段: 整数,
}

方法 示例 {
    函数 方法一() {
        // 实现
    }

    函数 方法二() {
        // 实现
    }
}
```

### 4. 空格

#### 运算符周围

```qi
// ✅ 正确
变量 x = 1 + 2;
变量 结果 = a * b + c / d;

// ❌ 错误
变量 x=1+2;
变量 结果=a*b+c/d;
```

#### 逗号后

```qi
// ✅ 正确
函数 示例(a: 整数, b: 整数, c: 整数) {
    变量 列表 = [1, 2, 3, 4, 5];
}

// ❌ 错误
函数 示例(a: 整数,b: 整数,c: 整数) {
    变量 列表 = [1,2,3,4,5];
}
```

#### 冒号后

```qi
// ✅ 正确
变量 名字: 字符串 = "值";
函数 测试(): 整数 {
    返回 42;
}

// ❌ 错误
变量 名字:字符串 = "值";
函数 测试():整数 {
    返回 42;
}
```

#### 控制流关键字后

```qi
// ✅ 正确
如果 条件 {
    // 代码
}
当 条件 {
    // 代码
}

// ❌ 错误
如果条件 {
    // 代码
}
当条件 {
    // 代码
}
```

### 5. 花括号位置

- **同行风格**（K&R）：左花括号在同一行

```qi
// ✅ 正确
函数 示例() {
    如果 条件 {
        打印("真");
    } 否则 {
        打印("假");
    }
}

// ❌ 错误（Allman 风格）
函数 示例()
{
    如果 条件
    {
        打印("真");
    }
    否则
    {
        打印("假");
    }
}
```

### 6. 导入语句

- 按字母顺序排序
- 分组：标准库 → 第三方 → 本地模块
- 组之间空一行

```qi
包 主程序;

// 标准库
导入 标准库.加密;
导入 标准库.输入输出;
导入 标准库.网络;

// 第三方库
导入 第三方.JSON;
导入 第三方.数据库;

// 本地模块
导入 ./工具;
导入 ./配置;
```

### 7. 函数参数

- 少于 4 个参数：同一行
- 4 个及以上参数：每个参数一行

```qi
// ✅ 正确（3 个参数）
函数 简单(a: 整数, b: 整数, c: 整数): 整数 {
    返回 a + b + c;
}

// ✅ 正确（4+ 个参数）
函数 复杂(
    第一参数: 整数,
    第二参数: 字符串,
    第三参数: 浮点数,
    第四参数: 布尔
): 整数 {
    返回 0;
}
```

### 8. 链式调用

- 每个方法调用一行
- 对齐点号

```qi
// ✅ 正确
变量 结果 = 文本
    .转小写()
    .去空格()
    .分割(",")
    .过滤(|x| x.长度() > 0);

// ❌ 错误
变量 结果 = 文本.转小写().去空格().分割(",").过滤(|x| x.长度() > 0);
```

### 9. 数组和列表

- 短列表（≤ 5 元素）：同一行
- 长列表（> 5 元素）：每个元素一行或多行

```qi
// ✅ 正确（短列表）
变量 短列表 = [1, 2, 3, 4, 5];

// ✅ 正确（长列表）
变量 长列表 = [
    1,
    2,
    3,
    4,
    5,
    6,
    7,
    8,
];
```

### 10. 结构体字面量

- 字段少于 3 个：同一行（可选）
- 字段 3 个及以上：每个字段一行

```qi
// ✅ 正确（2 个字段）
变量 点 = 坐标 { x: 10, y: 20 };

// ✅ 正确（3+ 个字段）
变量 用户 = 用户 {
    名字: "张三",
    年龄: 25,
    邮箱: "zhangsan@example.com",
};
```

### 11. 注释

- 单行注释：`//` 后跟一个空格
- 多行注释：适当缩进
- 文档注释：三斜杠 `///`

```qi
// ✅ 正确
// 这是单行注释

/*
 * 这是多行注释
 * 第二行
 */

/// 这是文档注释
/// 描述函数的功能
函数 示例() {
    // 代码
}

// ❌ 错误
//这是单行注释（缺少空格）
```

### 12. 对齐

- 不使用垂直对齐
- 使用自然缩进

```qi
// ✅ 正确
变量 短名字 = 1;
变量 很长的变量名 = 2;
变量 x = 3;

// ❌ 错误（垂直对齐）
变量 短名字       = 1;
变量 很长的变量名 = 2;
变量 x           = 3;
```

## 配置文件

### .qifmt.toml

可选配置文件，放在项目根目录：

```toml
# qifmt 配置文件

[格式化]
# 缩进空格数（默认: 4）
缩进 = 4

# 最大行长度（默认: 100）
最大行长 = 100

# 是否使用制表符（默认: false）
使用制表符 = false

# 尾随逗号（默认: true）
尾随逗号 = true

[导入]
# 导入排序（默认: true）
排序 = true

# 导入分组（默认: true）
分组 = true

[空格]
# 运算符周围空格（默认: true）
运算符空格 = true

# 逗号后空格（默认: true）
逗号后空格 = true

[注释]
# 保留注释位置（默认: true）
保留位置 = true
```

## 命令行使用

### 基本用法

```bash
# 格式化单个文件
qifmt 文件.qi

# 格式化多个文件
qifmt 文件1.qi 文件2.qi

# 格式化整个目录
qifmt 目录/

# 递归格式化
qifmt -r 项目目录/
```

### 选项

```bash
# 检查模式（不修改文件）
qifmt --check 文件.qi

# 显示差异
qifmt --diff 文件.qi

# 指定配置文件
qifmt --config 自定义.toml 文件.qi

# 静默模式
qifmt --quiet 文件.qi

# 详细输出
qifmt --verbose 文件.qi
```

### 示例

```bash
# 格式化并显示变更
qifmt --diff 主程序.qi

# 检查项目是否符合格式规范
qifmt --check -r src/

# 格式化所有 .qi 文件
find . -name "*.qi" | xargs qifmt
```

## 编辑器集成

### VS Code

在 `.vscode/settings.json` 中配置：

```json
{
  "qi.format.enable": true,
  "qi.format.onSave": true,
  "[qi]": {
    "editor.formatOnSave": true,
    "editor.defaultFormatter": "qi-lang.qi-vscode"
  }
}
```

### Vim

在 `.vimrc` 中添加：

```vim
autocmd FileType qi setlocal formatprg=qifmt\ -
```

### Emacs

在 `.emacs` 中添加：

```elisp
(add-hook 'qi-mode-hook
  (lambda ()
    (add-hook 'before-save-hook 'qi-format-buffer nil t)))
```

## 忽略格式化

### 单行忽略

```qi
// qifmt: skip
变量 保持原样 = 不会被格式化;
```

### 块忽略

```qi
// qifmt: skip-start
变量 x=1+2;
变量 y=3*4;
// qifmt: skip-end
```

### 文件忽略

在文件开头添加：

```qi
// qifmt: skip-file
```

或使用 `.qifmtignore` 文件：

```
# 忽略示例文件
示例/**/*.qi

# 忽略生成的代码
生成/*.qi

# 忽略特定文件
测试/legacy_code.qi
```

## 最佳实践

1. **团队协作**: 在项目中使用 `.qifmt.toml` 统一风格
2. **CI 集成**: 在 CI 中运行 `qifmt --check` 确保代码格式
3. **预提交钩子**: 使用 Git hooks 自动格式化
4. **编辑器集成**: 配置保存时自动格式化

## Git Hooks 示例

### pre-commit

```bash
#!/bin/sh
# .git/hooks/pre-commit

# 格式化所有暂存的 .qi 文件
git diff --cached --name-only --diff-filter=ACM | \
  grep '\.qi$' | \
  xargs qifmt

# 重新添加格式化后的文件
git diff --cached --name-only --diff-filter=ACM | \
  grep '\.qi$' | \
  xargs git add

exit 0
```

## 性能考虑

- 并行处理多个文件
- 缓存 AST 解析结果
- 增量格式化（仅格式化修改部分）

## 与其他工具比较

| 特性 | qifmt | rustfmt | gofmt |
|------|-------|---------|-------|
| 零配置 | ✅ | ✅ | ✅ |
| 可配置 | ✅ | ✅ | ❌ |
| 速度 | 快 | 快 | 很快 |
| 中文支持 | ✅ | ❌ | ❌ |

## 未来计划

- [ ] 支持更多配置选项
- [ ] 性能优化（增量格式化）
- [ ] 自动修复常见错误
- [ ] IDE 插件深度集成
- [ ] 格式化统计报告

---

**版本**: v0.1.0
**更新日期**: 2025-11-06
