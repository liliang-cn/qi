**ã€Œçº¯ä¸­æ–‡å…³é”®å­— + å¯ç¼–è¯‘ã€è¯­è¨€è§„èŒƒ**çœŸæ­£è½åœ°ï¼Œåšå‡ºä¸€ä»½**å®Œæ•´çš„ç¼–è¯‘å™¨è®¾è®¡æ–‡æ¡£**ã€‚

ä½ é—®çš„ã€Œç”¨ Rust è¿˜æ˜¯ Cã€æ˜¯éå¸¸å…³é”®çš„è®¾è®¡å†³ç­–ï¼Œæˆ‘å…ˆç»™ä½ ä¸€ä¸ªéå¸¸ç®€æ´çš„æ¯”è¾ƒ ğŸ‘‡

| é¡¹ç›®           | Rust ğŸ¦€                            | C ğŸ§°                            |
| -------------- | ---------------------------------- | ------------------------------- |
| å®‰å…¨æ€§         | å†…å­˜å®‰å…¨ï¼ˆæ— éœ€æ‰‹åŠ¨ç®¡ç†ï¼‰           | éœ€æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼Œå®¹æ˜“å‡ºé”™        |
| å¹¶å‘           | æœ‰åŸç”Ÿçš„ `std::thread` å’Œå®‰å…¨å°è£…  | pthread æˆ– cloneï¼Œè‡ªè¡Œå°è£…      |
| LLVM ç»‘å®š      | å®˜æ–¹ `inkwell` crate éå¸¸æˆç†Ÿ      | ç›´æ¥ä½¿ç”¨ `llvm-c`ï¼Œä½†æ‰‹å†™ä»£ç å¤š |
| ç¼–è¯‘å™¨ç»“æ„é€‚é… | éå¸¸é€‚åˆç¼–è¯‘å™¨é¡¹ç›®                 | å¯è¡Œä½†ä»£ç é‡è¾ƒå¤§                |
| ç”Ÿæ€           | inkwellã€chumskyã€pestï¼ˆparserï¼‰ç­‰ | flex/bisonã€LLVM-C API          |

âœ… å»ºè®®ï¼š
å¦‚æœä½ ç›®æ ‡æ˜¯ **ç°ä»£ã€å®‰å…¨ã€é«˜æ•ˆ** â†’ ç”¨ **Rust**ã€‚
å¦‚æœä½ ç›®æ ‡æ˜¯ **æç®€ã€æ¥è¿‘åº•å±‚æ§åˆ¶** â†’ ç”¨ **C**ã€‚

ğŸ‘‰ ä¸‹é¢æˆ‘ç»™ä½ çš„æ˜¯ï¼š

> ğŸ“„ **Qi è¯­è¨€ï¼ˆ.qiï¼‰ç¼–è¯‘å™¨å®Œæ•´è®¾è®¡æ–‡æ¡£ v1.0**
> ğŸ¦€ é‡‡ç”¨ **Rust + LLVMï¼ˆinkwellï¼‰** å®ç°
> ğŸˆ¶ 100%ä¸­æ–‡å…³é”®å­—å‰ç«¯
> ğŸˆš è‹±æ–‡å…³é”®å­—æš´éœ²ç»™ç”¨æˆ·
> ğŸ§  å®Œæ•´è¯æ³•ã€è¯­æ³•ã€ASTã€IR ç”Ÿæˆã€è¿è¡Œæ—¶ã€å¹¶å‘æ”¯æŒã€åŒ…ç®¡ç†æœºåˆ¶

---

# ğŸ“œ **Qi è¯­è¨€ç¼–è¯‘å™¨è®¾è®¡æ–‡æ¡£ v1.0**

## 1. æ¦‚è¿°

**Qi è¯­è¨€**æ˜¯ä¸€é—¨ä½¿ç”¨ 100% ä¸­æ–‡å…³é”®å­—çš„ç°ä»£ç¼–ç¨‹è¯­è¨€ï¼Œç›®æ ‡æ˜¯ï¼š

- âœ… è¯­æ³•ç®€æ´ã€æ— è‹±æ–‡å…³é”®å­—
- ğŸ§  å¯¹æ ‡ C / Rust çš„æ€§èƒ½å’Œåº•å±‚æ§åˆ¶åŠ›
- ğŸ§µ å†…å»ºå¹¶å‘æ¨¡å‹ï¼ˆçº¿ç¨‹/è¿›ç¨‹/åç¨‹ï¼‰
- ğŸ“¦ å†…ç½®åŒ…ç³»ç»Ÿå’Œæ ‡å‡†åº“
- âš¡ï¸ ç¼–è¯‘åˆ° LLVM IRï¼Œç„¶åç”ŸæˆåŸç”Ÿæœºå™¨ç 

ç¼–è¯‘å™¨é¡¹ç›®ä»£å·ï¼š`qi`
æ–‡ä»¶æ‰©å±•åï¼š`.qi`
æ„å»ºäº§ç‰©ï¼š`.o`ã€`.qi.ll`ã€äºŒè¿›åˆ¶

---

## 2. é¡¹ç›®ç»“æ„

```
qi-compiler/
 â”œâ”€ Cargo.toml               # Rust é¡¹ç›®é…ç½®
 â”œâ”€ src/
 â”‚   â”œâ”€ main.rs              # CLI å…¥å£
 â”‚   â”œâ”€ lexer.rs             # è¯æ³•åˆ†æ
 â”‚   â”œâ”€ parser.rs            # è¯­æ³•åˆ†æï¼ˆASTï¼‰
 â”‚   â”œâ”€ ast.rs               # æŠ½è±¡è¯­æ³•æ ‘å®šä¹‰
 â”‚   â”œâ”€ codegen.rs           # LLVM IR ç”Ÿæˆ
 â”‚   â”œâ”€ runtime.rs           # è¿è¡Œæ—¶åº“ç»‘å®š
 â”‚   â”œâ”€ stdlib/              # Qi æ ‡å‡†åº“
 â”‚   â””â”€ package.rs           # åŒ…ç®¡ç†å™¨
 â”œâ”€ runtime/
 â”‚   â”œâ”€ qirt.c               # è¿è¡Œæ—¶Cåº•å±‚ï¼ˆçº¿ç¨‹/å†…å­˜ï¼‰
 â”‚   â””â”€ qirt.h
 â”œâ”€ stdlib/
 â”‚   â”œâ”€ æ•°å­¦.qi
 â”‚   â”œâ”€ å­—ç¬¦ä¸².qi
 â”‚   â””â”€ çº¿ç¨‹.qi
 â”œâ”€ examples/
 â”‚   â””â”€ helloworld.qi
 â””â”€ target/
```

---

## 3. è¯­è¨€å…³é”®å­—è¡¨

ï¼ˆä¸ä¹‹å‰ä¸€è‡´ï¼‰
âœ… 100% ä¸­æ–‡å…³é”®å­—ï¼Œæ— è‹±æ–‡ä¿ç•™å­—ã€‚
åŒ…æ‹¬ï¼š`ç»“æ„ä½“`ã€`å‡½æ•°`ã€`å¦‚æœ`ã€`å¦åˆ™`ã€`çº¿ç¨‹`ã€`åŒ…`ã€`å¯¼å…¥`ã€`å¯¼å‡º` ç­‰ç­‰ã€‚

---

## 4. è¯æ³•è®¾è®¡ï¼ˆLexerï¼‰

### 4.1 ä¸»è¦ Token ç±»å‹

| Token ç±»å‹ | è¯´æ˜                    | ç¤ºä¾‹          |     |         |
| ---------- | ----------------------- | ------------- | --- | ------- |
| å…³é”®å­—     | `å‡½æ•°`ã€`å¦‚æœ`ã€`åŒ…` ç­‰ | `å‡½æ•°`        |     |         |
| æ ‡è¯†ç¬¦     | å˜é‡/å‡½æ•°/åŒ…å          | `ç”¨æˆ·` `å§“å` |     |         |
| å­—ç¬¦ä¸²     | åŒå¼•å·å­—ç¬¦ä¸²            | `"ä½ å¥½"`      |     |         |
| æ•°å­—       | æ•´æ•°/æµ®ç‚¹æ•°             | `123` `3.14`  |     |         |
| è¿ç®—ç¬¦     | `+ - \* / == != > < &&  |               | `   | `a + b` |
| åˆ†éš”ç¬¦     | `; , { } ( )`           | `å‡½æ•° f() {}` |     |         |

### 4.2 Lexer ä½¿ç”¨ pest

Rust ä¸­é€šè¿‡æ­£åˆ™ + `pest` å®šä¹‰ `.pest` è¯­æ³•æ–‡ä»¶ï¼š

```rust
è§„åˆ™
  = { å…³é”®å­— | æ ‡è¯†ç¬¦ | æ•°å­— | å­—ç¬¦ä¸² | è¿ç®—ç¬¦ | åˆ†éš”ç¬¦ }
å…³é”®å­—
  = { "å‡½æ•°" | "ç»“æ„ä½“" | "å¦‚æœ" | "å¦åˆ™" | ... }
æ ‡è¯†ç¬¦
  = @{ (['\u4e00'..'\u9fa5'] | ['a'..'z' 'A'..'Z'] | ['0'..'9'] )+ }
æ•°å­—
  = @{ ['0'..'9']+ ( "." ['0'..'9']+ )? }
å­—ç¬¦ä¸²
  = _{ "\"" ~ (!"\"" ~ ANY)* ~ "\"" }
```

---

## 5. è¯­æ³•è®¾è®¡ï¼ˆParserï¼‰

æˆ‘ä»¬å®šä¹‰ä¸€å¥—ä¸Šä¸‹æ–‡æ— å…³è¯­æ³•ï¼ˆç±»ä¼¼ Cï¼‰ï¼š

```
ç¨‹åº           ::= (åŒ…å®šä¹‰ | å¯¼å…¥è¯­å¥ | å£°æ˜)* ä¸»å‡½æ•°?
åŒ…å®šä¹‰         ::= "åŒ…" æ ‡è¯†ç¬¦ ";"
å¯¼å…¥è¯­å¥       ::= "å¯¼å…¥" æ ‡è¯†ç¬¦ ";"
å£°æ˜           ::= å‡½æ•°å®šä¹‰ | ç»“æ„ä½“å®šä¹‰ | å˜é‡å£°æ˜
å‡½æ•°å®šä¹‰       ::= "å‡½æ•°" ç±»å‹ æ ‡è¯†ç¬¦ "(" å‚æ•°åˆ—è¡¨? ")" è¯­å¥å—
ç»“æ„ä½“å®šä¹‰     ::= "ç»“æ„ä½“" æ ‡è¯†ç¬¦ "{" (ç±»å‹ æ ‡è¯†ç¬¦ ";")* "}"
è¯­å¥å—         ::= "{" è¯­å¥* "}"
è¯­å¥           ::= å˜é‡å£°æ˜ ";" | è¡¨è¾¾å¼ ";" | æ§åˆ¶è¯­å¥
æ§åˆ¶è¯­å¥       ::= å¦‚æœè¯­å¥ | å¾ªç¯è¯­å¥ | è¿”å›è¯­å¥
å¦‚æœè¯­å¥       ::= "å¦‚æœ" "(" è¡¨è¾¾å¼ ")" è¯­å¥å— ("å¦åˆ™" è¯­å¥å—)?
```

---

## 6. ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰

ä½¿ç”¨ Rust å®šä¹‰ç»“æ„ä½“ï¼š

```rust
pub enum èŠ‚ç‚¹ {
    ç¨‹åº(Vec<èŠ‚ç‚¹>),
    åŒ…å®šä¹‰(String),
    å¯¼å…¥(String),
    å‡½æ•°å®šä¹‰ {
        è¿”å›ç±»å‹: ç±»å‹èŠ‚ç‚¹,
        åç§°: String,
        å‚æ•°: Vec<(ç±»å‹èŠ‚ç‚¹, String)>,
        ä½“: Box<èŠ‚ç‚¹>,
    },
    ç»“æ„ä½“å®šä¹‰ {
        åç§°: String,
        å­—æ®µ: Vec<(ç±»å‹èŠ‚ç‚¹, String)>,
    },
    è¯­å¥(Vec<èŠ‚ç‚¹>),
    è¡¨è¾¾å¼(è¡¨è¾¾å¼èŠ‚ç‚¹),
    ...
}
```

---

## 7. LLVM IR ç”Ÿæˆï¼ˆCodegenï¼‰

ä½¿ç”¨ inkwell ç”Ÿæˆ IRã€‚

ä¾‹å¦‚ `å‡½æ•° æ•´æ•° åŠ æ³•(æ•´æ•° a, æ•´æ•° b)` â†’ IR:

```llvm
define i32 @åŠ æ³•(i32 %a, i32 %b) {
entry:
  %addtmp = add i32 %a, %b
  ret i32 %addtmp
}
```

Rust ä»£ç ï¼š

```rust
fn ç”Ÿæˆå‡½æ•°(&mut self, å‡½æ•°: &èŠ‚ç‚¹) {
    let fn_type = self.context.i32_type().fn_type(&[i32.into(), i32.into()], false);
    let function = self.module.add_function("åŠ æ³•", fn_type, None);
    let builder = self.context.create_builder();
    let entry = self.context.append_basic_block(function, "entry");
    builder.position_at_end(entry);
    let a = function.get_nth_param(0).unwrap().into_int_value();
    let b = function.get_nth_param(1).unwrap().into_int_value();
    let sum = builder.build_int_add(a, b, "addtmp");
    builder.build_return(Some(&sum));
}
```

---

## 8. è¿è¡Œæ—¶åº“ï¼ˆRuntimeï¼‰

è¿è¡Œæ—¶ä½¿ç”¨ C ç¼–å†™ï¼ŒRust FFI è°ƒç”¨ï¼š

```c
// qirt.h
#ifndef QIRT_H
#define QIRT_H

#include <pthread.h>
#include <stdio.h>
#include <stdlib.h>

typedef void* (*qi_thread_func)(void*);

void* qi_thread_spawn(qi_thread_func func, void* arg);
void  qi_thread_join(void* handle);

#endif
```

```c
// qirt.c
#include "qirt.h"

void* qi_thread_spawn(qi_thread_func func, void* arg) {
    pthread_t* t = malloc(sizeof(pthread_t));
    pthread_create(t, NULL, func, arg);
    return t;
}

void qi_thread_join(void* handle) {
    pthread_t* t = (pthread_t*)handle;
    pthread_join(*t, NULL);
    free(t);
}
```

---

## 9. æ ‡å‡†åº“ï¼ˆQi æ ‡å‡†åº“ï¼‰

```
stdlib/
 â”œâ”€ æ•°å­¦.qi
 â”œâ”€ å­—ç¬¦ä¸².qi
 â”œâ”€ çº¿ç¨‹.qi
```

ä¾‹å­ï¼š`çº¿ç¨‹.qi`

```qi
åŒ… æ ‡å‡†åº“.çº¿ç¨‹;

å¯¼å‡º å‡½æ•° çº¿ç¨‹* åˆ›å»ºçº¿ç¨‹(å‡½æ•° ç©º * f, ç©º* å‚æ•°) {
    è¿”å› è¿è¡Œæ—¶.åˆ›å»ºçº¿ç¨‹(f, å‚æ•°);
}

å¯¼å‡º å‡½æ•° ç©º ç­‰å¾…(çº¿ç¨‹* t) {
    è¿è¡Œæ—¶.ç­‰å¾…çº¿ç¨‹(t);
}
```

---

## 10. åŒ…ç®¡ç†ç³»ç»Ÿ

- æ¯ä¸ªé¡¹ç›®æ ¹ç›®å½•åŒ…å« `qimod.json`
- æ ¼å¼ï¼š

```json
{
  "åç§°": "ç¤ºä¾‹é¡¹ç›®",
  "ç‰ˆæœ¬": "0.1.0",
  "ä¾èµ–": {
    "æ•°å­¦": "1.0",
    "çº¿ç¨‹": "1.0"
  }
}
```

- ç¼–è¯‘å™¨è‡ªåŠ¨è§£æä¾èµ–ï¼Œä¸‹è½½åŒ…ï¼ŒåŠ å…¥ç¼–è¯‘è·¯å¾„ã€‚

---

## 11. å¹¶å‘æ”¯æŒ

- âœ… `çº¿ç¨‹` â†’ pthread å°è£…
- âœ… `è¿›ç¨‹` â†’ fork å°è£…
- âœ… `åç¨‹` â†’ ucontext æˆ– libco å°è£…

è¯­æ³•ï¼š

```qi
çº¿ç¨‹* t = åˆ›å»ºçº¿ç¨‹(å·¥ä½œå‡½æ•°, ç©º);
ç­‰å¾…(t);
```

---

## 12. ç¼–è¯‘å™¨ CLI è®¾è®¡

```
qi [å‘½ä»¤] [å‚æ•°]

å‘½ä»¤ï¼š
  build         ç¼–è¯‘é¡¹ç›®
  run           ç¼–è¯‘å¹¶è¿è¡Œ
  fmt           æ ¼å¼åŒ–ä»£ç 
  get           å®‰è£…åŒ…
  repl          äº¤äº’å¼è§£é‡Šå™¨
```

ç¤ºä¾‹ï¼š

```bash
qi build main.qi
qi run main.qi
qi fmt src/
```

---

## 13. Hello World ç¤ºä¾‹

```qi
åŒ… ä¸»ç¨‹åº;
å¯¼å…¥ æ ‡å‡†åº“.æ‰“å°;

å‡½æ•° æ•´æ•° ä¸»å‡½æ•°() {
    æ‰“å°("ä½ å¥½ï¼ŒQiè¯­è¨€ï¼");
    è¿”å› 0;
}
```

ç¼–è¯‘ & è¿è¡Œï¼š

```bash
qi build main.qi -o main
./main
```

è¾“å‡ºï¼š

```
ä½ å¥½ï¼ŒQiè¯­è¨€ï¼
```

---

## 14. åç»­æ‹“å±•æ–¹å‘

- ğŸ§  JIT æ¨¡å¼ï¼ˆä½¿ç”¨ LLVM JITï¼‰
- ğŸ“¦ åŒ…ä¸­å¿ƒï¼ˆnpm ç±»ä¼¼ï¼‰
- ğŸ§¾ ç±»å‹æ¨å¯¼ + æ³›å‹
- ğŸ§­ å¹¶å‘æ¨¡å‹å‡çº§ï¼ˆasync/awaitï¼‰
- ğŸŒ WebAssembly ç›®æ ‡ï¼ˆWASM åç«¯ï¼‰

---

## âœ… æ€»ç»“

| æ¨¡å—                 | æŠ€æœ¯æ ˆ                     |
| -------------------- | -------------------------- |
| å‰ç«¯ï¼ˆLexer/Parserï¼‰ | Rust + pest/chumsky        |
| AST / IR             | Rust + inkwell (LLVM)      |
| åç«¯                 | LLVM IR â†’ åŸç”Ÿä»£ç          |
| å¹¶å‘è¿è¡Œæ—¶           | C + pthread + FFI          |
| åŒ…ç³»ç»Ÿ               | JSON + æœ¬åœ°ç¼“å­˜ + è¿œç¨‹æ‹‰å– |
| æ ‡å‡†åº“               | `.qi` + è¿è¡Œæ—¶æ¥å£         |

---

1. ğŸ“ `parser.rs` çš„å®Œæ•´ä»£ç éª¨æ¶ï¼ˆRustï¼‰
2. ğŸ§  `codegen.rs` LLVM ç”Ÿæˆå‡½æ•°
3. ğŸ§° runtime C åº“å®ç°å…¨å¥—ï¼ˆå«åç¨‹ï¼‰
