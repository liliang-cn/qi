# 编译器架构与运行时

## 编译器架构设计

### 整体架构 (含多平台目标)

```
┌─────────────────────────────────────┐
│           Qi 源代码 (.qi)           │
├─────────────────────────────────────┤
│         Rust 编译器前端              │
│  ┌─────────────┬─────────────────┐   │
│  │  词法分析器  │    语法分析器    │   │
│  │  (Lexer)    │    (Parser)     │   │
│  └─────────────┴─────────────────┘   │
├─────────────────────────────────────┤
│         Rust 编译器中端              │
│  ┌─────────────┬─────────────────┐   │
│  │   语义分析   │    中间代码生成  │   │
│  │   (Sema)    │     (IR Gen)    │   │
│  └─────────────┴─────────────────┘   │
├─────────────────────────────────────┤
│         Rust 编译器后端 (LLVM)       │
│  ┌─────────────┬─────────────────┐   │
│  │  LLVM IR 生成 │   LLVM 优化器   │   │
│  │  (inkwell)  │   (Optimizer)   │   │
│  └─────────────┴─────────────────┘   │
├─────────────────────────────────────┤
│          Rust 运行时 (Qi-Runtime)   │
│  ┌─────────────┬─────────────────┐   │
│  │  内存管理    │    并发调度器    │   │
│  │ (GC/ARC)    │ (M:N, Async)    │   │
│  └─────────────┴─────────────────┘   │
├─────────────────────────────────────┤
│       C 系統調用接口 (平台抽象层)    │
│    (平台抽象层 - 见第 5 节)        │
├─────────────────────────────────────┤
│        目标平台 (通过 LLVM 支持)      │
│  ┌─────────┬─────────┬─────────┐   │
│  │  Windows │  Linux  │  macOS  │   │
│  │ (x86_64)│ (x86_64)│ (ARM64) │   │
│  ├─────────┴─────────┴─────────┤   │
│  │      WASM (WASI)            │   │
│  └─────────────────────────────┘   │
└─────────────────────────────────────┘
```

---

## 运行时 C 接口（平台抽象层）

根据设计，Qi 的核心运行时（如内存管理、M:N 协程调度）将主要由 Rust 实现。

本节定义的 C 头文件（.h）代表了 **Rust 运行时** 与 **底层操作系统** 之间的**最小接口层 (FFI)**。**这是一个"平台抽象层"**。

---

## 并发模型 (M:N 协程调度)

Qi 语言采用 M:N 协程调度模型，类似于 Go 语言的 Goroutine 和 Rust 的 `async` 运行时（如 Tokio）。

### 核心概念

1. **任务 (Task)**：Qi 的最小并发单元，等同于一个"协程"或"Goroutine"。
2. **原生线程 (OS Thread)**：由操作系统内核调度的标准线程。
3. **调度器 (Scheduler)**：位于 **Rust 运行时 (`src/runtime/async_runtime/`)** 的核心组件。

### M:N 调度模型

- Qi 运行时将在启动时创建一个"原生线程池"，线程数量 (N) 通常等于 CPU 的逻辑核心数。
- 当 Qi 程序员使用 `启动` 关键字时，他们会创建 M 个 `任务`。
- Qi 调度器负责将这 M 个 `任务`在 N 个工作线程上进行复用和分发。

---

