# Qi 语言规范 v0.1.0

## 目录

1. [简介](#简介)
2. [词法结构](#词法结构)
3. [语法结构](#语法结构)
4. [类型系统](#类型系统)
5. [表达式](#表达式)
6. [语句](#语句)
7. [函数和方法](#函数和方法)
8. [结构体和枚举](#结构体和枚举)
9. [模块系统](#模块系统)
10. [并发编程](#并发编程)
11. [内存管理](#内存管理)
12. [标准库](#标准库)

---

## 简介

### 设计目标

Qi (气) 是一门使用 100% 中文关键字的现代编程语言，具有以下特点：

- ✅ **完全中文化**: 所有关键字、类型和标准库都使用中文
- ✅ **静态类型**: 编译时类型检查，确保类型安全
- ✅ **高性能**: 基于 LLVM 编译为原生机器码
- ✅ **并发友好**: 内置协程、通道和同步原语
- ✅ **现代特性**: 支持异步编程、模式匹配、泛型（规划中）

### 文件扩展名

Qi 源文件使用 `.qi` 扩展名。

### 编码

所有 Qi 源文件必须使用 UTF-8 编码。

---

## 词法结构

### 注释

Qi 支持单行和多行注释：

```qi
// 这是单行注释

/*
 * 这是多行注释
 * 可以跨越多行
 */
```

### 关键字

Qi 的所有关键字都是中文：

**声明关键字**:
- `包` - 包声明
- `导入` - 导入模块
- `函数` - 函数声明
- `变量` - 不可变变量
- `可变` - 可变变量
- `结构体` - 结构体定义
- `枚举` - 枚举定义
- `方法` - 方法声明

**控制流关键字**:
- `如果` - if 条件
- `否则` - else 分支
- `当` - while 循环
- `对于` - for 循环
- `循环` - 无限循环
- `匹配` - match 模式匹配
- `返回` - return 语句
- `跳出` - break
- `继续` - continue

**可见性关键字**:
- `公开` - public
- `私有` - private

**其他关键字**:
- `等待` - await 异步等待
- `取地址` - address-of 运算符
- `解引用` - dereference 运算符
- `打印` - print 函数
- `打印行` - println 函数
- `真` - true
- `假` - false
- `空` - null/empty

### 标识符

标识符可以包含：
- 中文字符
- ASCII 字母 (a-z, A-Z)
- 数字 (0-9，但不能作为首字符)
- 下划线 (_)

**合法标识符**:
```qi
变量名
myVariable
_私有变量
计数器1
```

**非法标识符**:
```qi
1变量    // 不能以数字开头
变量-名   // 不能包含连字符
@变量    // 不能包含特殊符号
```

### 字面量

#### 整数字面量

```qi
42          // 十进制
0xFF        // 十六进制
0b1010      // 二进制
0o755       // 八进制
```

#### 浮点数字面量

```qi
3.14
1.0e10
2.5e-3
```

#### 字符串字面量

```qi
"Hello, 世界"
"支持转义: \n \t \r"
'单引号字符串'
```

#### 布尔字面量

```qi
真    // true
假    // false
```

### 标点符号

Qi 支持中英文混合标点：

**分号**: `;` 或 `；`
**逗号**: `,` 或 `，`
**句号**: `.` 或 `。`

**括号**:
- 圆括号: `()` 或 `（）`
- 方括号: `[]` 或 `［］`
- 花括号: `{}` 或 `【】`

**示例**:
```qi
// 英文标点
函数 测试() {
    变量 x = 10;
}

// 中文标点
函数 测试（）【
    变量 x = 10；
】

// 混合标点
函数 测试() 【
    变量 x = 10;
】
```

---

## 语法结构

### BNF 语法定义

```bnf
<程序> ::= <包声明> <导入语句>* <顶层声明>*

<包声明> ::= "包" <标识符> ";"

<导入语句> ::= "导入" <模块路径> ("as" <标识符>)? ";"
             | "导入" <模块路径> "{" <标识符列表> "}" ";"

<顶层声明> ::= <函数声明>
              | <结构体声明>
              | <枚举声明>
              | <变量声明>

<函数声明> ::= <可见性>? "函数" <标识符> "(" <参数列表>? ")" (":" <类型>)? <块语句>

<参数列表> ::= <参数> ("," <参数>)*

<参数> ::= <标识符> ":" <类型>

<块语句> ::= "{" <语句>* "}"

<语句> ::= <变量声明>
          | <赋值语句>
          | <表达式语句>
          | <返回语句>
          | <如果语句>
          | <循环语句>
          | <块语句>

<表达式> ::= <字面量>
            | <标识符>
            | <二元表达式>
            | <一元表达式>
            | <函数调用>
            | <取地址表达式>
            | <解引用表达式>
```

---

## 类型系统

### 基本类型

| 中文类型 | 说明 | 大小 | 范围 |
|---------|------|------|------|
| `整数` | 有符号整数 | 64位 | -2^63 ~ 2^63-1 |
| `长整数` | 长整数 | 128位 | 扩展范围 |
| `短整数` | 短整数 | 32位 | -2^31 ~ 2^31-1 |
| `字节` | 字节 | 8位 | 0 ~ 255 |
| `浮点数` | 双精度浮点 | 64位 | IEEE 754 |
| `单精度浮点` | 单精度浮点 | 32位 | IEEE 754 |
| `布尔` | 布尔值 | 1位 | 真/假 |
| `字符` | Unicode 字符 | 32位 | U+0000 ~ U+10FFFF |
| `字符串` | UTF-8 字符串 | 动态 | 任意长度 |

### 复合类型

#### 数组

固定大小的同类型元素序列：

```qi
变量 数组: [整数; 5] = [1, 2, 3, 4, 5];
变量 字符串数组: [字符串; 3] = ["甲", "乙", "丙"];
```

#### 列表

动态大小的同类型元素序列：

```qi
变量 列表: 列表<整数> = [1, 2, 3];
列表。添加(4);
```

#### 字典

键值对集合：

```qi
变量 字典: 字典<字符串, 整数> = {
    "甲": 1,
    "乙": 2,
    "丙": 3
};
```

#### 指针

指向其他值的引用：

```qi
变量 数值 = 42;
变量 指针 = 取地址 数值;
变量 值 = 解引用 指针;
```

### 未来类型（异步）

用于异步操作的类型：

```qi
函数 异步计算(): 未来<整数> {
    返回 42;
}

函数 主函数() {
    变量 结果 = 等待 异步计算();
}
```

### 类型推断

Qi 支持类型推断，可以省略显式类型标注：

```qi
变量 x = 42;          // 推断为 整数
变量 名字 = "张三";    // 推断为 字符串
变量 列表 = [1, 2, 3]; // 推断为 [整数]
```

---

## 表达式

### 算术表达式

```qi
变量 a = 10 + 5;   // 加法
变量 b = 10 - 5;   // 减法
变量 c = 10 * 5;   // 乘法
变量 d = 10 / 5;   // 除法
变量 e = 10 % 3;   // 取模
```

### 比较表达式

```qi
变量 相等 = (a == b);  // 等于
变量 不等 = (a != b);  // 不等于
变量 大于 = (a > b);   // 大于
变量 小于 = (a < b);   // 小于
变量 大等 = (a >= b);  // 大于等于
变量 小等 = (a <= b);  // 小于等于
```

### 逻辑表达式

```qi
变量 与 = (真 && 假);  // 逻辑与
变量 或 = (真 || 假);  // 逻辑或
变量 非 = !真;          // 逻辑非
```

### 函数调用表达式

```qi
变量 结果 = 函数名(参数1, 参数2);
变量 方法结果 = 对象.方法名(参数);
```

### 指针表达式

```qi
变量 数值 = 42;
变量 指针 = 取地址 数值;    // 或 & 数值
变量 值 = 解引用 指针;      // 或 * 指针
```

### 运算符优先级

从高到低：

1. 成员访问 (`.`), 函数调用 `()`
2. 一元运算符 (`!`, `-`, `取地址`, `解引用`)
3. 乘除模 (`*`, `/`, `%`)
4. 加减 (`+`, `-`)
5. 比较 (`<`, `<=`, `>`, `>=`)
6. 相等 (`==`, `!=`)
7. 逻辑与 (`&&`)
8. 逻辑或 (`||`)
9. 赋值 (`=`, `+=`, `-=`, 等)

---

## 语句

### 变量声明

```qi
// 不可变变量
变量 x: 整数 = 10;
变量 名字 = "张三";  // 类型推断

// 可变变量
可变 计数器: 整数 = 0;
计数器 = 计数器 + 1;
```

### 赋值语句

```qi
可变 x = 10;
x = 20;          // 简单赋值
x += 5;          // 复合赋值
x -= 3;
x *= 2;
x /= 4;
x %= 3;
```

### 条件语句

```qi
如果 条件 {
    // 条件为真时执行
} 否则 如果 其他条件 {
    // 其他条件为真时执行
} 否则 {
    // 所有条件都不满足时执行
}
```

### 循环语句

#### 当循环（while）

```qi
可变 i = 0;
当 i < 10 {
    打印行(i);
    i += 1;
}
```

#### 对于循环（for）

```qi
变量 列表 = [1, 2, 3, 4, 5];
对于 元素 在 列表 {
    打印行(元素);
}
```

#### 无限循环

```qi
循环 {
    如果 条件 {
        跳出;  // break
    }
    继续;      // continue
}
```

### 返回语句

```qi
函数 加法(a: 整数, b: 整数): 整数 {
    返回 a + b;
}
```

### 匹配语句

```qi
匹配 值 {
    1 => 打印("一"),
    2 => 打印("二"),
    3 => 打印("三"),
    _ => 打印("其他"),
}
```

---

## 函数和方法

### 函数声明

```qi
// 基本函数
函数 问候(名字: 字符串) {
    打印行("你好，", 名字);
}

// 带返回值的函数
函数 加法(a: 整数, b: 整数): 整数 {
    返回 a + b;
}

// 多个参数
函数 计算(a: 整数, b: 整数, c: 整数): 整数 {
    返回 (a + b) * c;
}
```

### 公开函数

```qi
// 导出给其他模块使用
公开 函数 公共接口(): 字符串 {
    返回 "可以被其他模块调用";
}

// 私有函数（默认）
函数 内部实现() {
    // 只能在本模块内使用
}
```

### 方法

方法是关联到结构体的函数：

```qi
结构体 矩形 {
    宽度: 浮点数,
    高度: 浮点数,
}

方法 矩形 {
    函数 面积(): 浮点数 {
        返回 自己.宽度 * 自己.高度;
    }

    函数 周长(): 浮点数 {
        返回 2.0 * (自己.宽度 + 自己.高度);
    }
}
```

### 异步函数

```qi
函数 异步获取数据(): 未来<字符串> {
    // 异步操作
    返回 "数据";
}

函数 主函数() {
    变量 数据 = 等待 异步获取数据();
    打印行(数据);
}
```

---

## 结构体和枚举

### 结构体

```qi
// 定义结构体
结构体 用户 {
    名字: 字符串,
    年龄: 整数,
    邮箱: 字符串,
}

// 创建实例
变量 用户1 = 用户 {
    名字: "张三",
    年龄: 25,
    邮箱: "zhangsan@example.com",
};

// 访问字段
打印行(用户1.名字);

// 修改字段（需要可变）
可变 用户2 = 用户1;
用户2.年龄 = 26;
```

### 元组结构体

```qi
结构体 坐标(浮点数, 浮点数);

变量 点 = 坐标(10.0, 20.0);
```

### 枚举

```qi
枚举 颜色 {
    红色,
    绿色,
    蓝色,
}

枚举 选项<T> {
    有(T),
    无,
}

变量 颜色值 = 颜色::红色;
变量 可能有值 = 选项::有(42);
```

---

## 模块系统

### 包声明

每个 Qi 文件必须以包声明开始：

```qi
包 主程序;
```

### 导入模块

```qi
// 导入整个模块
导入 标准库;

// 导入特定项
导入 标准库 { 打印, 打印行 };

// 使用别名
导入 标准库.输入输出 as IO;

// 相对路径导入
导入 ./工具;           // 当前目录
导入 ../父级模块;      // 父目录
导入 ../../祖父模块;   // 祖父目录
```

### 模块结构

```
项目/
├── 主程序.qi          (包 主程序)
├── 工具/
│   ├── 字符串.qi      (包 工具.字符串)
│   └── 数学.qi        (包 工具.数学)
└── 服务/
    └── HTTP.qi       (包 服务.HTTP)
```

---

## 并发编程

### 协程

```qi
函数 启动协程() {
    协程 {
        打印行("在协程中执行");
    };
}
```

### 通道

```qi
// 创建通道
变量 通道 = 创建通道<整数>();

// 发送数据
协程 {
    通道 <- 42;
};

// 接收数据
变量 值 = <- 通道;
```

### 选择语句

```qi
选择 {
    值1 = <- 通道1 => 打印("从通道1收到:", 值1),
    值2 = <- 通道2 => 打印("从通道2收到:", 值2),
    超时(1000) => 打印("超时"),
}
```

### 互斥锁

```qi
变量 锁 = 创建互斥锁();
变量 共享数据 = 0;

函数 安全更新() {
    锁。加锁();
    共享数据 += 1;
    锁。解锁();
}
```

---

## 内存管理

### 栈分配

小对象和基本类型默认在栈上分配：

```qi
变量 数值 = 42;              // 栈分配
变量 小数组 = [1, 2, 3];     // 栈分配（小数组）
```

### 堆分配

大对象自动在堆上分配：

```qi
变量 大数组 = [0; 10000];   // 堆分配（大数组）
变量 字符串 = "长字符串..."; // 堆分配
```

### 指针操作

```qi
变量 数值 = 42;
变量 指针 = 取地址 数值;
变量 引用值 = 解引用 指针;

// 修改通过指针
可变 可变数值 = 100;
变量 可变指针 = 取地址 可变数值;
解引用 可变指针 = 200;
```

### 生命周期

Qi 使用引用计数和作用域规则管理内存：

```qi
{
    变量 临时 = "在作用域内";
    // 使用 临时
} // 临时 在此处被释放
```

---

## 标准库

### 输入输出

```qi
导入 标准库.输入输出;

打印("不换行");
打印行("自动换行");

变量 输入 = 读取行();
```

### 字符串操作

```qi
变量 文本 = "Hello";
变量 长度 = 文本。长度();
变量 大写 = 文本。转大写();
变量 包含 = 文本。包含("ell");
```

### 集合操作

```qi
// 列表
变量 列表 = [1, 2, 3];
列表。添加(4);
列表。移除(0);
变量 长度 = 列表。长度();

// 字典
变量 字典 = 创建字典<字符串, 整数>();
字典。插入("甲", 1);
变量 值 = 字典。获取("甲");
```

### 文件操作

```qi
导入 标准库.文件系统;

变量 内容 = 读取文件("文件.txt");
写入文件("输出.txt", "内容");
```

### 网络操作

```qi
导入 标准库.网络;

变量 响应 = HTTP。获取("https://example.com");
打印行(响应。内容);
```

### 加密

```qi
导入 标准库.加密;

变量 哈希 = MD5("数据");
变量 签名 = HMAC("密钥", "消息");
```

---

## 附录

### A. 关键字完整列表

**声明**: 包, 导入, 函数, 变量, 可变, 结构体, 枚举, 方法
**控制流**: 如果, 否则, 当, 对于, 循环, 匹配, 返回, 跳出, 继续
**可见性**: 公开, 私有
**类型**: 整数, 浮点数, 字符串, 布尔, 字符, 列表, 字典, 指针, 未来
**字面量**: 真, 假, 空
**运算符**: 取地址, 解引用, 等待
**内置**: 打印, 打印行

### B. 运算符表

| 运算符 | 说明 | 示例 |
|--------|------|------|
| `+` | 加法 | `a + b` |
| `-` | 减法 | `a - b` |
| `*` | 乘法 | `a * b` |
| `/` | 除法 | `a / b` |
| `%` | 取模 | `a % b` |
| `==` | 等于 | `a == b` |
| `!=` | 不等于 | `a != b` |
| `>` | 大于 | `a > b` |
| `<` | 小于 | `a < b` |
| `>=` | 大于等于 | `a >= b` |
| `<=` | 小于等于 | `a <= b` |
| `&&` | 逻辑与 | `a && b` |
| `\|\|` | 逻辑或 | `a \|\| b` |
| `!` | 逻辑非 | `!a` |
| `.` | 成员访问 | `对象.字段` |
| `&` | 取地址 | `&变量` |
| `*` | 解引用 | `*指针` |
| `<-` | 通道发送 | `通道 <- 值` |
| `->` | 返回类型 | `函数(): -> 整数` |

### C. 文件模板

**主程序模板**:

```qi
包 主程序;

函数 入口() {
    打印行("你好，世界！");
}
```

**模块模板**:

```qi
包 模块名;

公开 函数 公开函数() {
    // 公开接口
}

函数 私有函数() {
    // 内部实现
}
```

---

## 版本历史

- **v0.1.0** (2025-01): 初始规范
  - 基础语法和类型系统
  - 函数和结构体
  - 模块系统
  - 并发原语
  - 指针支持

---

## 贡献

本规范随 Qi 语言发展持续更新。欢迎提出建议和改进。

**许可**: MIT License
