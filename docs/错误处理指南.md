# Qi 语言错误处理指南

## 概述

Qi 编译器提供全面的中文错误消息系统，帮助开发者快速定位和解决问题。

## 错误代码分类

所有错误都有唯一的错误代码，格式为 `Exxxx`，其中数字表示错误类别：

- **E1xxx**: 词法分析错误（字符、字符串、数字）
- **E2xxx**: 语法分析错误（标点、语法结构）
- **E3xxx**: 类型检查错误（类型不匹配、未定义）
- **E4xxx**: 模块和导入错误
- **E5xxx**: 内存和指针错误
- **E6xxx**: 并发错误
- **E7xxx**: 运行时错误
- **E8xxx**: IO 错误

## 常见错误示例

### E1001: 意外的字符

**错误代码**: `E1001`
**消息**: 意外的字符 '{字符}'
**提示**: 请检查是否使用了不支持的符号或特殊字符

**示例**:
```qi
变量 x = 10;
变量 y @ 20;  // 错误 [E1001]: 意外的字符 '@'
```

**解决方案**: 移除或替换不支持的字符

---

### E1002: 未结束的字符串

**错误代码**: `E1002`
**消息**: 未结束的字符串字面量
**提示**: 字符串必须以引号结束

**示例**:
```qi
打印("你好世界);  // 错误 [E1002]: 未结束的字符串字面量
                  // 提示: 字符串必须以引号结束
```

**解决方案**: 添加结束引号
```qi
打印("你好世界");  // 正确
```

---

### E2003: 缺少分号

**错误代码**: `E2003`
**消息**: 缺少分号 ';' 或 '；'
**提示**: 中文分号 '；' 和英文分号 ';' 都支持

**示例**:
```qi
变量 x = 10
变量 y = 20  // 错误 [E2003]: 缺少分号 ';' 或 '；'
```

**解决方案**: 添加分号（中英文都可以）
```qi
变量 x = 10;  // 英文分号
变量 y = 20；  // 中文分号
```

---

### E3001: 类型不匹配

**错误代码**: `E3001`
**消息**: 类型不匹配: 期望 '{期望类型}'，但得到 '{实际类型}'

**示例**:
```qi
变量 数值: 整数 = "文本";
// 错误 [E3001]: 类型不匹配: 期望 '整数'，但得到 '字符串'
```

**解决方案**: 确保类型匹配
```qi
变量 数值: 整数 = 42;      // 正确
变量 文本: 字符串 = "文本";  // 正确
```

---

### E3002: 未定义的变量

**错误代码**: `E3002`
**消息**: 未定义的变量 '{变量名}'
**提示**: 请确保变量已声明

**示例**:
```qi
函数 测试() {
    打印(未声明的变量);
    // 错误 [E3002]: 未定义的变量 '未声明的变量'
}
```

**解决方案**: 先声明变量
```qi
函数 测试() {
    变量 已声明的变量 = 10;
    打印(已声明的变量);  // 正确
}
```

---

### E4001: 模块未找到

**错误代码**: `E4001`
**消息**: 模块 '{模块名}' 未找到
**提示**: 请检查模块路径和包声明是否正确

**示例**:
```qi
导入 不存在的模块;
// 错误 [E4001]: 模块 '不存在的模块' 未找到
```

**解决方案**:
1. 确认模块文件存在
2. 检查包声明是否正确
3. 使用正确的相对路径

```qi
导入 ./工具;     // 当前目录
导入 ../父级模块;  // 父目录
```

---

### E5001: 无效的解引用

**错误代码**: `E5001`
**消息**: 无效的解引用操作: '{表达式}' 不是指针类型
**提示**: 只能对指针类型使用 '解引用' 或 '*' 运算符

**示例**:
```qi
变量 数值 = 42;
变量 结果 = 解引用 数值;
// 错误 [E5001]: 无效的解引用操作: '数值' 不是指针类型
```

**解决方案**: 只对指针使用解引用
```qi
变量 数值 = 42;
变量 指针 = 取地址 数值;
变量 结果 = 解引用 指针;  // 正确
```

---

### E7001: 除以零

**错误代码**: `E7001`
**消息**: 除以零错误
**提示**: 除数不能为零

**示例**:
```qi
变量 x = 10 / 0;  // 运行时错误 [E7001]: 除以零错误
```

**解决方案**: 添加检查
```qi
变量 除数 = 0;
如果 除数 != 0 {
    变量 x = 10 / 除数;
} 否则 {
    打印("除数不能为零");
}
```

---

## 错误格式说明

Qi 编译器的错误消息包含以下部分：

```
错误 [E3001]: 类型不匹配: 期望 '整数'，但得到 '字符串'
位置: 示例.qi:10:15
提示: 请确保表达式类型与声明类型匹配
```

**组成部分**:
1. **错误代码**: `[E3001]` - 唯一标识错误类型
2. **错误消息**: 中文描述问题
3. **位置信息**: 文件名、行号、列号
4. **提示**: 如何解决问题的建议

## 在代码中使用错误

### 基本用法

```rust
use qi_compiler::error::messages::*;
use qi_compiler::qi_error;

// 创建简单错误
let err = qi_error!(E3002_UNDEFINED_VARIABLE, "变量名");

// 创建带位置信息的错误
let err = QiErrorBuilder::new("E3001", "类型不匹配")
    .hint("请检查类型声明")
    .location("test.qi", 10, 5)
    .build();
```

### 格式化错误消息

```rust
use qi_compiler::error::messages::*;

let err_msg = E3001_TYPE_MISMATCH.format(&["整数", "字符串"]);
// 输出: "类型不匹配: 期望 '整数'，但得到 '字符串'"
```

### 使用工具函数

```rust
use qi_compiler::error::messages::utils::*;

// 带错误代码的格式化
let msg = format_error(&E2003_MISSING_SEMICOLON, &[]);
// 输出: "错误 [E2003]: 缺少分号 ';' 或 '；'"

// 带提示的格式化
let msg_with_hint = format_error_with_hint(&E2003_MISSING_SEMICOLON, &[]);
```

## 最佳实践

1. **使用错误代码**: 总是使用预定义的错误代码，而不是自定义字符串
2. **提供上下文**: 在错误消息中包含相关的变量名、类型等信息
3. **添加位置信息**: 尽可能提供文件名、行号和列号
4. **编写有帮助的提示**: 提示应该告诉用户如何修复问题
5. **保持一致性**: 使用统一的错误消息格式和术语

## 扩展错误系统

要添加新的错误类型：

1. 在 `src/error/messages.rs` 中定义错误常量
2. 选择合适的错误代码（遵循分类规则）
3. 编写清晰的中文消息
4. 提供有用的提示（如果适用）
5. 在 `get_error_by_code` 中添加映射
6. 添加测试用例

**示例**:

```rust
pub const E9001_NEW_ERROR: ErrorMessage = ErrorMessage {
    code: "E9001",
    message: "新错误类型的描述",
    hint: Some("如何解决这个问题"),
};
```

## 相关资源

- [错误代码完整列表](错误代码列表.md)
- [编译器开发指南](../CLAUDE.md)
- [语言规范](语言规范.md)
